<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Content Manager</title>
</head>
<body>
<h1 style="text-align:center;margin-top:2rem;">Content Manager Login</h1>

<!-- Decap CMS -->
<script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>

<!-- Auth0 SDK -->
<script src="https://cdn.auth0.com/js/auth0-spa-js/2.1/auth0-spa-js.production.js"></script>

<script>
    document.addEventListener("DOMContentLoaded", async () => {
        // Initialize Auth0 client
        const auth0 = await createAuth0Client({
            domain: "{{ getenv "AUTH0_DOMAIN" }}",
            client_id: "{{ getenv "AUTH0_CLIENT_ID" }}",
            redirect_uri: window.location.origin + "/admin/"
        });

        // Handle redirect after login
        if (window.location.search.includes("code=") && window.location.search.includes("state=")) {
            await auth0.handleRedirectCallback();
            window.history.replaceState({}, document.title, "/admin/");
        }

        const isAuthenticated = await auth0.isAuthenticated();

        if (!isAuthenticated) {
            // Redirect to Auth0 login page
            await auth0.loginWithRedirect();
            return;
        }

        // User is authenticated, now init CMS
        const token = await auth0.getTokenSilently();
        window.CMS_USER_TOKEN = token;

        CMS.init({
            config: {
                backend: {
                    name: "git-gateway",
                    branch: "main",
                    auth_scope: "repo",
                },
                media_folder: "static/images/uploads",
                public_folder: "/images/uploads",
            }
        });
    });
</script>
</body>
</html>
